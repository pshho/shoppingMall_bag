<html xmlns="http://www.thymeleaf.org">
<h1 th:each="cate:${categoriesList}"
th:if="${productsBoard.categoriesId eq cate.categoriesId}"
th:text="${cate.categoriesName}"></h1>
<hr />
<section class="shopDetail">
	<!-- 상품 관련 정보 -->
	<div>
		<table border="">
			<tr>
				<td colspan="2">사진 들어갈 곳</td>
			</tr>
			<tr>
				<td colspan="2">
					<div th:utext="${productsBoard.contents}"></div>
				</td>
			</tr>
			<tr>
				<td>사이즈</td>
				<td th:text="|${bags.bagSizeW}/${bags.bagSizeH}/${bags.bagSizeD}|"></td>
			</tr>
			<tr>
				<td>용량</td>
				<td th:text="${bags.bagCapacity}"></td>
			</tr>
			<tr>
				<td>무게</td>
				<td th:text="${bags.bagWeight}"></td>
			</tr>
			<tr>
				<td>겉감</td>
				<td th:text="${bags.bagOuterFabric}"></td>
			</tr>
			<tr>
				<td>안감</td>
				<td th:text="${bags.bagInnerFabric}"></td>
			</tr>
			<tr>
				<td>지퍼</td>
				<td th:text="${bags.bagZipper}"></td>
			</tr>
			<tr>
				<td>버클</td>
				<td th:text="${bags.bagBuckle}"></td>
			</tr>
			<tr>
				<td>제조연월</td>
				<td th:text="${bags.bagsProductionDay2}"></td>
			</tr>
			<tr>
				<td colspan="2" th:text="${productsBoard.guide}"></td>
			</tr>
		</table>
	</div>
	<!-- 배송, 결제 관련 정보 -->
	<div>
		<table border="">
			<tr>
				<td colspan="3" th:each="brand:${brandList}"
					th:if="${brand.brandId eq productsBoard.brandId}"
					th:text="${brand.brandName}"></td>
			</tr>
			<tr>
				<td colspan="3" th:text="${bags.bagName}"></td>
			</tr>
			<tr>
				<td colspan="3" th:text="${bags.bagPrice}"></td>
			</tr>
			<tr>
				<td>상품코드</td>
				<td colspan="2" th:text="${bags.productCode}"></td>
			</tr>
			<tr>
				<td>배송정보</td>
				<td colspan="2" th:text="${productsBoard.addressInfo}"></td>
			</tr>
			<tr>
				<td>결제관련정보</td>
				<td colspan="2">결제관련정보</td>
			</tr>
			<tr>
				<td rowspan="5">상품설명</td>
				<tr>
					<td colspan="2" th:text="${bags.bagComment}"></td>
				</tr>
				<tr>
					<td>정면길이</td>
					<td th:text="${bags.bagSizeW}"></td>
				</tr>
				<tr>
					<td>높이</td>
					<td th:text="${bags.bagSizeH}"></td>
				</tr>
				<tr>
					<td>측면길이</td>
					<td th:text="${bags.bagSizeD}"></td>
				</tr>
			</tr>
			<th:block th:if="${bags.bagStock != 0}">
				<tr>
					<td th:text="${bags.bagName}"></td>
					<td>
						<button type="button" onclick="subAmount()">-</button>
						<input type="text" th:value="${bags.amount}" id="bagsAmount" />
						<button type="button" onclick="addAmount()">+</button>
					</td>
					<td>
						<input type="text" th:value="${bags.totalPrice}" id="bagsTotal" readonly />
					</td>
				</tr>
				<tr>
					<td>총 상품금액</td>
					<td colspan="2">
						<input type="text" th:value="${bags.totalPrice}" id="bagsTotal" readonly />
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<button type="button" onclick="cartAdd()">장바구니</button>
						<a href="/orders/orders">바로구매</a>
					</td>
				</tr>
			</th:block>
			<th:block th:unless="${bags.bagStock != 0}">
				<tr>
					<td colspan="3">품절</td>
				</tr>
			</th:block>
			<tr>
				<td colspan="3">
					<a th:if="${session.admin ne null}"
					th:href="|/shopping/shoppingModify/${productsBoard.productsBoardId}|">수정</a>
					<a th:if="${session.admin ne null}" href="#" 
					th:onclick="|confirmDelete(${productsBoard.productsBoardId})|">삭제</a>
					<a th:href="|/shopping/shoppingList/${brand}/${category}/${type}/1|">뒤로</a>
				</td>
			</tr>
		</table>
	</div>
</section>
<script th:inline="javascript">
	function addAmount(){
		let bagsAmount = null;
		if(!isNaN($('#bagsAmount').val())){
			bagsAmount = parseInt($('#bagsAmount').val()) + 1;
		}else {
			alert('숫자를 입력해주세요');
			return false;
		}
		let stock = [[${bags.bagStock}]];
		if(bagsAmount > stock){
			alert(stock+'개까지 선택할 수 있습니다');
			return false;
		}
		
		$('#bagsAmount').val(bagsAmount);
		const params = {
			bagsAmount : bagsAmount
		}
		const bagsTotal = document.querySelectorAll('#bagsTotal');
		
		$.ajax({
			url : '/shopping/shoppingDetail',
			type : 'post',
			contentType : 'application/json; charset=utf-8',
			dataType : 'json',
			data : JSON.stringify(params),
			success : function(res){
				bagsTotal.forEach(function(item){
					item.value = res.totalPrice;
				})
			},
			error : function(error){
				console.log(error);
			}
		})
	}
	
	function subAmount(){
		let bagsAmount = null;
		if(!isNaN($('#bagsAmount').val())){
			bagsAmount = parseInt($('#bagsAmount').val()) - 1;
		}else {
			alert('숫자를 입력해주세요');
			return false;
		}
		if(bagsAmount < 1){
			alert('상품은 1개 이상 선택해야 합니다');
			return false;
		}
		$('#bagsAmount').val(bagsAmount);
		const params = {
			bagsAmount : bagsAmount
		}
		const bagsTotal = document.querySelectorAll('#bagsTotal');
		
		$.ajax({
			url : '/shopping/shoppingDetail',
			type : 'post',
			contentType : 'application/json; charset=utf-8',
			dataType : 'json',
			data : JSON.stringify(params),
			success : function(res){
				bagsTotal.forEach(function(item){
					item.value = res.totalPrice;
				})
			},
			error : function(error){
				console.log(error);
			}
		})
	}
	
	$(document).ready(function(){
		let delay;
		$('#bagsAmount').keyup(function(event){
			clearTimeout(delay);
			delay = setTimeout(function(){
				let bagsAmount = null;
				if(!isNaN($('#bagsAmount').val())){
					bagsAmount = parseInt($('#bagsAmount').val());
				}else {
					alert('숫자를 입력해주세요');
					return false;
				}
				let stock = [[${bags.bagStock}]];
				
				if(bagsAmount < 1){
					alert('상품은 1개 이상 선택해야 합니다');
					return false;
				}else if(bagsAmount > stock){
					alert(stock+'개까지 선택할 수 있습니다');
					return false;
				}
				
				const params = {
					bagsAmount : bagsAmount
				}
				const bagsTotal = document.querySelectorAll('#bagsTotal');
				
				$.ajax({
					url : '/shopping/shoppingDetail',
					type : 'post',
					contentType : 'application/json; charset=utf-8',
					dataType : 'json',
					async : false,
					data : JSON.stringify(params),
					success : function(res){
						bagsTotal.forEach(function(item){
							item.value = res.totalPrice;
						})
					},
					error : function(error){
						console.log(error);
					}
				})
			}, 300);
		})
	})
	
	function confirmation(msg, url, cartCount){
		if(confirm(msg+'\n장바구니로 이동하시겠습니까?')){
			location.href=url;
		}
		$('#cartLink').text('장바구니('+cartCount+')');
	}
	
	function cartAdd(){
		let bagsAmount = null;
		if(!isNaN($('#bagsAmount').val())){
			bagsAmount = parseInt($('#bagsAmount').val());
		}else {
			alert('숫자를 입력해주세요');
			return false;
		}
		
		const params = {
			bagsAmount : bagsAmount
		}
		
		$.ajax({
			url : '/shopping/shoppingCart',
			type : 'post',
			contentType : 'application/json; charset=utf-8',
			dataType : 'json',
			async : false,
			data : JSON.stringify(params),
			success : function(res){
				confirmation(res.msg, res.url, res.cartCount);
			},
			error : function(error){
				console.log(error);
			}
		})
	}
</script>